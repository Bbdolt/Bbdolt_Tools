import json
import requests

with open("./ai_config.json", "r", encoding="utf-8") as f:
    json_data = json.load(f)

API_TOKEN = json_data.get('API_TOKEN', "")
API_URL = json_data.get('openai_url', 'https://api.siliconflow.cn/v1') + "/chat/completions"
MODEL_NAME = json_data.get('MODEL_NAME', 'Qwen/Qwen2.5-Coder-7B-Instruct')

def analyze_urls():
    # 系统prompt配置
    system_prompt = """{"task":"URI路径拼接风险分析，并输出指定JSON格式","problem":"直接拼接域名和JS提取的URI导致404错误","requirements":["分析成功路径与原始URI的拼接规律","推测可能的base_url或路径转换规则","生成无404风险的完整URL"],"input_data":{"successful_path":["https://api.service.com/base/v1/users/info","https://api.service.com/base/v2/orders","https://auth.service.com/identity/token","https://cdn.service.com/assets/fonts/"],"raw_uris":["/base/v3/products",//绝对路径（新版本）"./details",//当前目录相对路径"../config",//父目录相对路径"api/endpoint"//无前缀相对路径]},"output_format":{"强制要求":"结果必须是纯JSON，无额外文本","强制JSON结构":{"results":[{"raw_uri":"输入URI","possible_results":["完整URL1","完整URL2"]}],"global_patterns":"拼接规则描述"},"results":[{"possible_results":["https://api.service.com/base/v3/products"]},{"possible_results":["https://api.service.com/base/v2/details"]},{"possible_results":["https://api.service.com/base/config","https://cdn.service.com/config"//多域名方案]},{"possible_results":["https://api.service.com/base/v2/api/endpoint"]}],"global_patterns":["BaseURL规则: api.service.com使用/base/{version}/, auth.service.com使用/identity/, cdn.service.com使用/assets/","相对路径解析: ./ 继承最近同域成功路径目录，../ 回溯父目录（可能跨域）","版本推断: 未出现版本号时继承最近版本（如v2），新版本（v3）延续现有模式"]},"special_cases":{"multi_scenario_rules":{"relative_paths":{"./":"基于最近同域名成功路径（如最后api请求是/base/v2/orders -> ./details = /base/v2/details）","../":"优先回溯同域名路径，无匹配时启用跨域方案（如../config 可能指向 /base/ 或 /assets/）"},"version_handling":"新版本号（v3）延续现有API域名规则，静态资源路径默认使用CDN域名","domain_fallback":"歧义路径提供2个最可能的域名方案（基于路径关键字：api->service, config->cdn）"},"confidence_indicators":["路径重复度：/base/ 在成功路径出现3次（高置信）","域名占比：api.service.com占75%请求（主域名）","层级深度：成功路径平均3级目录，相对路径需匹配此深度"]}"""
    
    # 构建对话消息
    messages = [
        {
            "role": "system",
            "content": f"你是一个专业的URI安全分析引擎。严格遵循以下分析规范：{json.dumps(system_prompt, ensure_ascii=False)}"
        },
        {
            "role": "user",
            "content": r'{"successful_path": ["https://qtedu.om.moe.edu.cn/web_logs", "https://courseapi.ulearning.cn/textbook/cheatCheck?loginName=admin0901", "https://d.alicdn.com/alilog/mlog/aplus/204458013.js", "https://courseapi.ulearning.cn/users/login/refresh10Session?uaToken=", "https://courseapi.ulearning.cn/users/check?loginName=admin0901&password=wenhua123", "https://courseapi.ulearning.cn/users/loginApi?loginName=admin0901", "https://courseapi.ulearning.cn/users/login/v2", "https://courseapi.ulearning.cn/users/isValidToken/7591E4370109E1B6A3A3E663F8F7DC6E?lang=zh", "https://courseapi.ulearning.cn/users/menu/userMenuList?lang=zh", "https://nx-s3.ntalker.com/client-init/api/gate/kf/kf_20125", "https://nx-s3-trail.ntalker.com/skyeye/enterprises/kf_20125/collector/handler", "https://courseapi.ulearning.cn/manager/systemManager/public/information?domain=www&lang=zh", "https://courseapi.ulearning.cn/homepage/officeAnnouncement?lang=zh", "https://courseapi.ulearning.cn/ulearning/jsconfig?lang=zh", "https://courseapi.ulearning.cn/users/menu/hasMenu/v3?menuKey=ai_workbenches&lang=zh", "https://courseapi.ulearning.cn/messages/unreadcount?lang=zh", "https://courseapi.ulearning.cn/admin/config/3755?lang=zh", "https://courseapi.ulearning.cn/news?pn=1&ps=6&category=1&lang=zh", "https://courseapi.ulearning.cn/system/index/banner?homePageId=0&lang=zh", "https://courseapi.ulearning.cn/homepage/selectedTextbooks?lang=zh", "https://courseapi.ulearning.cn/homepage/selectedCourses?lang=zh", "https://courseapi.ulearning.cn/users/menu/hasMenuByCode?code=applicationCenter&userId=9267589&lang=zh", "https://courseapi.ulearning.cn/homepage/nationalCourses?lang=zh", "https://courseapi.ulearning.cn/getOrgan?lang=zh", "https://courseapi.ulearning.cn/admin/liveclasses?&orgId=3755&date=2025-07-28&pn=1&ps=10&lang=zh", "https://courseapi.ulearning.cn/admin/institutions/college?orgId=3755&lang=zh", "https://www.ulearning.cn/portal/null", "https://courseapi.ulearning.cn/admin/course/spoc?orgId=3755&collegeId=-1&state=-1&year=-1&keyword=&pn=1&ps=15&lang=zh", "https://courseapi.ulearning.cn/users/menu/hasMenu?menuId=54&userId=9267589&lang=zh", "https://courseapi.ulearning.cn/admin/exams?orgId=3755&pn=1&ps=15&state=-1&collegeId=-1&lang=zh", "https://www.ulearning.cn/admin/modules/dataCenter/teachingDynamic/teachingDynamicCtrl.js?ver=1", "https://www.ulearning.cn/admin/common/js/services/DataCenter.js?ver=1", "https://www.ulearning.cn/admin/modules/dataCenter/dataCenter.html", "https://www.ulearning.cn/admin/modules/dataCenter/teachingDynamic/teachingDynamic.html?ver=1", "https://courseapi.ulearning.cn/dataCenter/teaching/todayDynamic/login?college=&lang=zh", "https://courseapi.ulearning.cn/dataCenter/teaching/todayDynamic/activity?college=&lang=zh", "https://courseapi.ulearning.cn/dataCenter/teaching/loginTrend?college=&roleId=9&lang=zh", "https://courseapi.ulearning.cn/dataCenter/teaching/rank/course?college=&type=2&lang=zh"], "raw_uris": ["/web_logs", "/textbook/cheatCheck?loginName=admin0901", "/aplus.autolog.", "/alipaym_logs", "/aplus.autolog.clk", "/$$_", "/wxm_logs", "/baidum_logs", "/bytedancem_logs", "/go/act/", "/ddm_logs", "/inject.record.gokey", "/users/login/refresh10Session?uaToken=", "/users/check?loginName=admin0901&password=wenhua123", "/users/loginApi?loginName=admin0901", "/users/login/v2", "/users/isValidToken/7591E4370109E1B6A3A3E663F8F7DC6E?lang=zh", "/users/menu/userMenuList?lang=zh", "/client-init/api/gate/kf/kf_20125", "/skyeye/enterprises/kf_20125/collector/handler", "/manager/systemManager/public/information?domain=www&lang=zh", "/homepage/officeAnnouncement?lang=zh", "/ulearning/jsconfig?lang=zh", "/users/menu/hasMenu/v3?menuKey=ai_workbenches&lang=zh", "/messages/unreadcount?lang=zh", "/admin/config/3755?lang=zh", "/news?pn=1&ps=6&category=1&lang=zh", "/system/index/banner?homePageId=0&lang=zh", "/homepage/selectedTextbooks?lang=zh", "/homepage/selectedCourses?lang=zh", "/users/menu/hasMenuByCode?code=applicationCenter&userId=9267589&lang=zh", "/homepage/nationalCourses?lang=zh", "/getOrgan?lang=zh", "/admin/liveclasses?&orgId=3755&date=2025-07-28&pn=1&ps=10&lang=zh", "/admin/institutions/college?orgId=3755&lang=zh", "/portal/null", "/admin/course/spoc?orgId=3755&collegeId=-1&state=-1&year=-1&keyword=&pn=1&ps=15&lang=zh", "/users/menu/hasMenu?menuId=54&userId=9267589&lang=zh", "/admin/exams?orgId=3755&pn=1&ps=15&state=-1&collegeId=-1&lang=zh", "/dataCenter/teaching/exportSemeterForWeek?college=", "/dataCenter/teaching/exportTwoweekdynamic?college=", "/dataCenter/teaching/exportSemeterForMonth?college=", "/interactiveCourse/getEditVideoOverview/", "/interactiveCourse/getOpenedStudentNum/", "/teaching/getUploadQuestionAnalysis?productId=", "/dataCenter/homework/teaTop?college=", "/dataCenter/course/courseSizeDistrubution?college=", "/dataCenter/teaching/loginTrend?college=&roleId=9&lang=zh", "/classroom/activity/getVoteAnalysis?productId=", "/dataCenter/homework/homeworkTotal?college=", "/teaching/getCoursewareTop?productId=", "/dataCenter/discussion/courseTop?college=", "/dataCenter/academy/courseDataForCollege?college=", "/dataCenter/discussion/discussionDistribute?college=", "/interactiveCourse/getVideoChapterOverview/", "/teaching/getCheckInfo?productId=", "/dataCenter/academy/loginDataForCollege?college=", "/dataCenter/course/teachModelAnalyze?college=", "/teaching/getCoursewareUpdateNum?productId=", "/teaching/activity/getExamInfo?productId=", "/dataCenter/homework/homeworkDistribute?college=", "/teaching/activity/getDiscussTeacherPostTop?productId=", "/dataCenter/live/liveDistribute?college=", "/platform/getTeacherRank?productId=", "/classroom/activity/getAnswerInfo?productId=", "/dataCenter/live/courseTop?college=", "/classroom/activity/getAttendanceTop?productId=", "/interactiveCourse/getEditExerciseOverview/", "/teaching/activity/getDiscussInfo?productId=", "/teaching/getBaseData?productId=", "/interactiveCourse/getCourseOverview/", "/classroom/activity/getAnswerTop?productId=", "/dataCenter/resource/teaTop?college=", "/interactiveCourse/getEditExerciseChapterOverview/", "/teaching/getCheckTop?productId=", "/interactiveCourse/getExerciseOverview/", "/interactiveCourse/getEditVideoChapterOverview/", "/teaching/activity/getJobInfo?productId=", "/teaching/activity/getAnnouncementTop?productId=", "/teaching/activity/getJobTop?productId=", "/teaching/activity/getDiscussTop?productId=", "/dataCenter/exam/examTotal?college=", "/dataCenter/exam/stuTop?college=", "/dataCenter/teaching/twoweekdynamic?college=", "/teaching/getQuestionUploadTop?productId=", "/dataCenter/teaching/todayDynamic/login?college=&lang=zh", "/platform/getCourseRank?productId=", "/dataCenter/resource/courseTop?college=", "/teaching/activity/getAnnouncementInfo?productId=", "/interactiveCourse/getChapterOverview/", "/teaching/activity/getDiscussAnalysis?productId=", "/classroom/activity/getAttendanceInfo?productId=", "/dataCenter/course/evaluationMethod?college=", "/dataCenter/discussion/teaTop?college=", "/classroom/activity/getVoteInfo?productId=", "/teaching/getCheckAnalysis?productId=", "/dataCenter/exam/stuDeviceDistribute?college=", "/platform/getTotalLogin?productId=", "/teaching/getUploadResourceTop?productId=", "/teaching/getUploadQuestionInfo?productId=", "/dataCenter/activity/signAnalyze?college=", "/platform/getActiveUserData?token=", "/camera/enter/total/", "/classroom/activity/getAttendanceAnalysis?productId=", "/teaching/getUploadResourceAndTeaNum?productId=", "/teaching/getLearningPlan?productId=", "/teaching/activity/getJobAnalysis?productId=", "/dataCenter/resource/resourceDistribute?college=", "/dataCenter/activity/classActivity?college=", "/textbook/", "/dataCenter/teaching/rank/student?college=", "/platform/getBaseData?productId=", "/dataCenter/activity/teaTop?college=", "/dataCenter/homework/courseTop?college=", "/dataCenter/activity/courseTop?college=", "/platform/getStudentRank?productId=", "/interactiveCourse/getVideoOverview/", "/dataCenter/course/courseGeneral?college=", "/platform/getStuLoginTrend?productId=", "/teaching/activity/getExamAnalysis?productId=", "/dataCenter/activity/activityTotal?college=", "/dataCenter/discussion/discussionTotal?college=", "/dataCenter/teaching/rank/teacher?college=", "/teaching/activity/getAnnouncementAnalysis?productId=", "/classroom/activity/getVoteTop?productId=", "/teaching/activity/getDiscussStudentPostTop?productId=", "/classroom/activity/getAnswerAnalysis?productId=", "/interactiveCourse/getExerciseChapterOverview/", "/teaching/getUploadResourceInfo?productId=", "/dataCenter/teaching/todayDynamic/activity?college=&lang=zh", "/interactiveCourse/getEditOpenedStudentNum/", "/dataCenter/live/teaTop?college=", "/dataCenter/teaching/rank/course?college=&type=2&lang=zh", "/platform/getTeaLoginTrend?productId=", "/teaching/activity/getExamTop?productId=", "/dataCenter/exam/examTypeDistribute?college=", "/teaching/getCreateQuestionSummary?productId=", "/dataCenter/resource/resourceTotal?college=", "/dataCenter/academy/coursewareDataForCollege?college=", "/dataCenter/live/liveTotal?college=", "/admin/modules/dataCenter/dataCenter.html", "/admin/modules/dataCenter/teachingDynamic/teachingDynamic.html?ver=1"]}'
        }
    ]

    # API请求参数
    payload = {
        "model": MODEL_NAME,
        "messages": messages,
        "temperature": 0.1,
        "max_tokens": 4000
    }

    headers = {
        "Authorization": f"Bearer {API_TOKEN}",
        "Content-Type": "application/json"
    }
    
    try:
        response = requests.post(
            API_URL, 
            json=payload, 
            headers=headers
        )
        response.raise_for_status()
        result = response.json()
        print(result['choices'][0]['message']['content'])
    
    except:
        print("error")

analyze_urls()